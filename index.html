<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs TTS App - Admin User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            padding: 1rem; 
            color: #cbd5e1;
            overflow-x: hidden; 
        }
        .auth-container, .app-container {
            max-width: 500px; 
            width: 100%;
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: rgba(30, 41, 59, 0.7); 
            border-radius: 1rem; 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(51, 65, 85, 0.7);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.7s ease-out forwards;
        }
        .app-container { max-width: 700px; position: relative; } 

        @keyframes fadeInSlideUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { to { opacity: 1; } }

        /* Admin Panel Styles */
        .admin-panel-toggle { 
            position: fixed; top: 1rem; left: 1rem; background-color: rgba(45, 212, 191, 0.2);
            color: #2dd4bf; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; z-index: 1001;
            transition: all 0.3s ease; border: 1px solid rgba(45, 212, 191, 0.5);
        }
        .admin-panel-toggle:hover { background-color: rgba(45, 212, 191, 0.4); }
        .admin-panel { 
            position: fixed; top: 0; left: -450px; /* Increased width */ width: 450px; height: 100vh;
            background-color: rgba(15, 23, 42, 0.97); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-right: 1px solid #2dd4bf; padding: 1.5rem;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3); z-index: 1000; transition: left 0.4s ease-in-out;
            overflow-y: auto; color: #e2e8f0;
        }
        .admin-panel.open { left: 0; }
        .admin-panel h2, .admin-panel h3 { color: #2dd4bf; font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #2dd4bf; padding-bottom: 0.5rem; }
        .admin-panel h3 { font-size: 1.25rem; margin-top: 1.5rem; }
        .admin-log-entry, .admin-user-entry { 
            background-color: rgba(51, 65, 85, 0.4); padding: 0.75rem; border-radius: 0.375rem;
            margin-bottom: 0.75rem; font-size: 0.875rem; border-left: 3px solid #2dd4bf;
        }
        .admin-log-entry p, .admin-user-entry p { margin-bottom: 0.25rem; } 
        .admin-log-entry strong, .admin-user-entry strong { color: #94a3b8; }
        .admin-user-entry .actions button {
            background-color: rgba(45, 212, 191, 0.3); color: #2dd4bf;
            padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 0.25rem; margin-right: 0.5rem;
            border: 1px solid rgba(45, 212, 191, 0.5);
        }
        .admin-user-entry .actions button:hover { background-color: rgba(45, 212, 191, 0.5); }
        .admin-user-entry .actions .delete-btn { background-color: rgba(239, 68, 68, 0.3); color: #f87171; border-color: rgba(239, 68, 68, 0.5);}
        .admin-user-entry .actions .delete-btn:hover { background-color: rgba(239, 68, 68, 0.5); }


        /* Modal Styles */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1002;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { 
            background-color: #1e293b; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 400px; text-align: center;
        }
        .modal-content .label { color: #94a3b8; } .modal-content .input { margin-bottom: 1rem; }
        .modal-content .button { margin-top: 0.5rem; }

        /* Common styles */
        .label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #94a3b8; font-size: 0.9rem; }
        .input, .textarea, .select {
            width: 100%; padding: 0.875rem; background-color: rgba(51, 65, 85, 0.6); 
            border: 1px solid rgba(71, 85, 105, 0.8); border-radius: 0.5rem; color: #e2e8f0;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        #voiceSearchInput { margin-bottom: 0.75rem; padding: 0.75rem 1rem; }
        .input::placeholder, .textarea::placeholder { color: #64748b; }
        .input:focus, .textarea:focus, .select:focus {
            outline: none; border-color: #2dd4bf; background-color: rgba(51, 65, 85, 0.8); 
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.3), 0 5px 15px rgba(45, 212, 191, 0.1);
            transform: translateY(-1px);
        }
        .button { 
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color: white; padding: 0.875rem 1.5rem;
            border: none; border-radius: 0.5rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center; width: 100%; margin-top: 1rem;
        }
        .button:hover:not(:disabled) { 
            transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(20, 184, 166, 0.3);
            background: linear-gradient(135deg, #0d9488 0%, #2dd4bf 100%);
        }
        .button:disabled { 
            background: rgba(71, 85, 105, 0.5); color: rgba(148, 163, 184, 0.7); cursor: not-allowed;
            transform: translateY(0) scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .whatsapp-button {
            background: #25D366; color: white; margin-top: 1.5rem;
            display: inline-flex; align-items: center; justify-content: center; width: auto; padding: 0.75rem 1.5rem;
        }
        .whatsapp-button:hover { background: #1DAE50; }
        .whatsapp-button i { margin-right: 0.5rem; }

        .user-info {
            position: absolute; top: 1.5rem; right: 1.5rem; text-align: right; z-index: 10;
            opacity: 0; animation: fadeIn 0.5s ease-out 0.5s forwards; font-size: 0.9rem;
        }
        .user-info p { margin-bottom: 0.25rem; }
        .logout-button {
            background: none; border: none; color: #f87171; 
            text-decoration: underline; cursor: pointer; padding: 0.25rem 0; font-size: 0.9rem;
        }
        .logout-button:hover { color: #ef4444; }
        
        h2.auth-title { color: #e2e8f0; font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; text-align:center; }
        .error-message { 
            color: #f87171; background-color: rgba(127, 29, 29, 0.3); border: 1px solid rgba(220, 38, 38, 0.5);
            padding: 1rem; text-align: center; font-weight: 500; margin-top: 1rem; border-radius: 0.5rem;
        }
        .loading-spinner { 
            border: 4px solid rgba(71, 85, 105, 0.3); border-top: 4px solid #2dd4bf; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .app-container h1 { 
            font-weight: 800; color: #f1f5f9; text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            margin-top: 0; 
            opacity: 0; animation: fadeIn 0.5s ease-out 0.2s forwards; font-size: 2.25rem; 
        }
        .app-container header p { 
            color: #94a3b8; opacity: 0; animation: fadeIn 0.5s ease-out 0.35s forwards; font-size: 1.125rem;
        }
        .form-section { margin-top: 1.5rem; opacity: 0; animation: fadeInSlideUp 0.6s ease-out forwards; }
        .app-container > .form-section:nth-of-type(1) { animation-delay: 0.3s; } 
        .app-container > .form-section:nth-of-type(2) { animation-delay: 0.4s; } 
        .app-container > .form-section:nth-of-type(3) { animation-delay: 0.5s; } 
        .app-container > .form-section:nth-of-type(4) { animation-delay: 0.6s; }
        #convertBtn { opacity: 0; animation: fadeInSlideUp 0.6s ease-out 0.7s forwards; }

        /* Responsive adjustments */
        @media (max-width: 768px) { 
            .auth-container, .app-container { padding: 2rem; margin: 1rem auto; }
            .app-container h1 { font-size: 1.875rem; }
            .app-container header p { font-size: 1rem; }
            .user-info { font-size:0.8rem; right: 1rem; top: 1rem;}
            .button { padding: 0.875rem 1.25rem; font-size: 0.875rem; }
            .input, .textarea, .select { padding: 0.875rem; }
            .admin-panel { width: 320px; left: -320px; } /* Adjusted width */
        }
        @media (max-width: 480px) { 
            body { padding: 0.5rem; }
            .auth-container, .app-container { padding: 1.5rem; margin: 0.5rem auto; margin-top: 1rem; }
            .app-container {margin-top: 4rem; } 
            .app-container h1 { font-size: 1.5rem; }
            .app-container header p { font-size: 0.875rem; }
            .user-info {width: calc(100% - 80px); text-align:left; left: 70px;} 
            .button { padding: 0.75rem 1rem; font-size: 0.8rem; }
            .admin-panel { width: 100%; left: -100%; border-right: none; } 
            .admin-panel.open { left: 0; }
            .admin-panel-toggle { padding: 0.6rem; font-size: 0.9rem;}
        }
        .hidden { display: none !important; }
        hr.admin-divider { border-color: rgba(71, 85, 105, 0.8); margin: 1.5rem 0; }
    </style>
</head>
<body>
    <button id="adminPanelToggle" class="admin-panel-toggle hidden">
        <i class="fas fa-cogs"></i> Admin
    </button>
    <div id="adminPanel" class="admin-panel">
        <h2>Admin Panel</h2>
        
        <h3>Create New User</h3>
        <form id="adminCreateUserForm" class="space-y-3">
            <div>
                <label for="adminNewUserName" class="label">Name:</label>
                <input type="text" id="adminNewUserName" class="input" required>
            </div>
            <div>
                <label for="adminNewUserEmail" class="label">Email:</label>
                <input type="email" id="adminNewUserEmail" class="input" required>
            </div>
            <div>
                <label for="adminNewUserPassword" class="label">Password:</label>
                <input type="password" id="adminNewUserPassword" class="input" required>
            </div>
            <div>
                <label for="adminUserExpiry" class="label">Access Duration:</label>
                <select id="adminUserExpiry" class="select">
                    <option value="1">1 Day</option>
                    <option value="7" selected>7 Days</option>
                    <option value="15">15 Days</option>
                    <option value="30">30 Days</option>
                    <option value="0">No Expiry</option> 
                </select>
            </div>
            <button type="submit" id="adminCreateUserBtn" class="button text-sm py-2">Create User</button>
            <p id="adminCreateUserError" class="error-message hidden text-xs py-2"></p>
            <p id="adminCreateUserSuccess" class="text-green-400 text-xs py-2 hidden"></p>
        </form>

        <hr class="admin-divider">

        <h3>Manage Users</h3>
        <div id="adminManageUsersContainer">
            <p>Loading users...</p>
        </div>
        
        <hr class="admin-divider">

        <h3>Activity Logs</h3>
        <div id="adminLogsContainer"><p>Login to view logs.</p></div>
    </div>

    <div id="adminPasswordModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-slate-200">Admin Login</h3>
            <label for="adminPassword" class="label text-left">Password:</label>
            <input type="password" id="adminPassword" class="input bg-slate-700 border-slate-600" placeholder="Enter admin password">
            <p id="adminPasswordError" class="text-red-400 text-sm mt-1 mb-3 hidden"></p>
            <button id="adminLoginBtn" class="button w-full">Login</button>
            <button id="adminModalCloseBtn" class="button w-full bg-slate-600 hover:bg-slate-500 mt-2">Close</button>
        </div>
    </div>

    <div id="authContainer" class="auth-container">
        <form id="loginForm" class="">
            <h2 class="auth-title">User Login</h2>
            <div class="mb-4">
                <label for="loginEmail" class="label">Email</label>
                <input type="email" id="loginEmail" class="input" required placeholder="your@email.com">
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="label">Password</label>
                <input type="password" id="loginPassword" class="input" required placeholder="••••••••">
            </div>
            <p id="loginError" class="error-message hidden"></p>
            <button type="submit" class="button">Login</button>
            <a href="https://wa.me/+923064482383" target="_blank" class="button whatsapp-button">
                <i class="fab fa-whatsapp"></i> Contact for Account Start from 99 PKR
            </a>
        </form>
        </div>

    <div id="appContainer" class="app-container hidden">
        <div class="user-info" id="userInfo">
            <p id="userEmailDisplay"></p>
            <button id="logoutButton" class="logout-button">Logout</button>
        </div>
        
        <header class="text-center mb-8">
            <h1>ElevenLabs TTS App</h1>
            <p class="text-slate-400 mt-2 text-lg">Convert text to audio.</p>
        </header>

        <div class="form-section mb-6 api-key-section hidden">
            <label for="apiKey" class="label">Your ElevenLabs API Key:</label>
            <input type="password" id="apiKey" class="input" placeholder="Paste your API Key here">
            <p class="text-xs text-slate-500 mt-1">Your key is saved locally for your account.</p>
        </div>

        <div class="form-section mb-6">
            <label for="textToConvert" class="label">Text to Convert:</label>
            <textarea id="textToConvert" rows="4" class="textarea" placeholder="Enter your text here..."></textarea>
        </div>

        <div class="form-section mb-6">
            <label for="voiceSelect" class="label">Select Voice:</label>
            <input type="text" id="voiceSearchInput" class="input" placeholder="Search voices..." disabled>
            <select id="voiceSelect" class="select mt-2" disabled>
                <option value="" style="color: #94a3b8;">Enter API Key to load voices...</option>
            </select>
        </div>
        
        <div class="form-section mb-6">
            <label for="modelSelect" class="label">Select Model:</label>
            <select id="modelSelect" class="select">
                <option value="eleven_multilingual_v2" selected>Eleven Multilingual v2</option>
                <option value="eleven_multilingual_v1">Eleven Multilingual v1</option>
                <option value="eleven_monolingual_v1">Eleven Monolingual v1</option>
            </select>
        </div>

        <button id="convertBtn" class="button w-full py-3.5 mb-4" disabled>
            <span id="buttonText" class="mr-2">Convert to Audio</span>
            <div id="loadingSpinner" class="loading-spinner hidden"></div>
        </button>

        <button id="downloadBtn" class="button download-button w-full py-3.5 hidden">
            <i class="fas fa-download mr-2"></i> Download Audio
        </button>

        <audio id="audioPlayer" controls class="audio-player hidden mt-6"></audio>
        <div id="appErrorMessage" class="error-message hidden mt-4"></div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            // deleteUser // Note: deleteUser can only be called on the currently signed-in user from client.
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, 
            doc, setDoc, getDoc, updateDoc, deleteDoc, Timestamp // Added Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        // Signup form elements are removed from general user access
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const logoutButton = document.getElementById('logoutButton');
        const adminPanelToggleBtn = document.getElementById('adminPanelToggle'); 

        const apiKeyInput = document.getElementById('apiKey');
        const apiKeySection = document.querySelector('.api-key-section'); 
        const textToConvertInput = document.getElementById('textToConvert');
        const voiceSearchInput = document.getElementById('voiceSearchInput'); 
        const voiceSelect = document.getElementById('voiceSelect');
        const modelSelect = document.getElementById('modelSelect');
        const convertBtn = document.getElementById('convertBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const audioPlayer = document.getElementById('audioPlayer');
        const downloadBtn = document.getElementById('downloadBtn');
        const appErrorMessage = document.getElementById('appErrorMessage'); 

        // Admin Panel Elements
        const adminPanel = document.getElementById('adminPanel');
        const adminLogsContainer = document.getElementById('adminLogsContainer');
        const adminPasswordModal = document.getElementById('adminPasswordModal');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminModalCloseBtn = document.getElementById('adminModalCloseBtn');
        const adminPasswordError = document.getElementById('adminPasswordError');
        const adminCreateUserForm = document.getElementById('adminCreateUserForm');
        const adminNewUserNameInput = document.getElementById('adminNewUserName');
        const adminNewUserEmailInput = document.getElementById('adminNewUserEmail');
        const adminNewUserPasswordInput = document.getElementById('adminNewUserPassword');
        const adminUserExpirySelect = document.getElementById('adminUserExpiry');
        const adminCreateUserBtn = document.getElementById('adminCreateUserBtn');
        const adminCreateUserError = document.getElementById('adminCreateUserError');
        const adminCreateUserSuccess = document.getElementById('adminCreateUserSuccess');
        const adminManageUsersContainer = document.getElementById('adminManageUsersContainer');


        const ELEVENLABS_API_BASE_URL = 'https://api.elevenlabs.io/v1';
        const ADMIN_PASSWORD = "Monopoly1.@"; 
        let currentAudioBlobUrl = null; 
        let allVoices = []; 
        let isAdminLoggedIn = false;
        let unsubscribeLogs = null; 
        let unsubscribeUsers = null;
        let currentUser = null; 

        // --- Firebase Setup ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDtKupraU6Ug-m4smjBI0AriDnTHxBqpfY",
            authDomain: "myelevenlabs-18ad9.firebaseapp.com",
            projectId: "myelevenlabs-18ad9",
            storageBucket: "myelevenlabs-18ad9.firebasestorage.app",
            messagingSenderId: "892386214766",
            appId: "1:892386214766:web:0000cf3c2cec4c0337777f",
            measurementId: "G-GK8FR0P65Y"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-elevenlabs-app';
        let app, auth, db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully. App ID:", appId);
        } catch (error) {
            console.error("Firebase initialization error:", error);
            displayAppError("Could not connect to services. Please try again later.");
        }
        
        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, `users/${user.uid}`);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.accountExpiry && userData.accountExpiry.toDate() < new Date()) {
                        displayLoginError("Your account has expired. Please contact admin.");
                        await signOut(auth); // Log out expired user
                        return;
                    }
                    currentUser = { ...user, ...userData }; // Combine auth user with firestore data
                } else {
                    // This case might happen if user was created in Auth but not in Firestore users collection
                    // Or for the admin user if not explicitly added to 'users' collection
                    // For simplicity, we'll assume admin doesn't need an expiry or is handled differently
                    // If it's a regular user without a Firestore record, they might be new or an anomaly.
                    // For now, let them proceed if they are not the admin.
                    // A robust system would ensure every auth user has a corresponding Firestore user record.
                    console.warn(`User document not found in Firestore for UID: ${user.uid}. They might not have expiry set.`);
                    currentUser = user; // Use auth user data only
                     // If this user is not the admin (e.g. based on email), and no userDoc, consider it an issue.
                    if (user.email !== "YOUR_ADMIN_EMAIL@example.com") { // Replace with actual admin email
                        // displayLoginError("User account not fully configured. Please contact admin.");
                        // await signOut(auth);
                        // return;
                    }
                }


                console.log("User is signed in:", currentUser.uid, currentUser.email, currentUser.displayName);
                userEmailDisplay.textContent = `Logged in: ${currentUser.displayName || currentUser.email}`;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                adminPanelToggleBtn.classList.remove('hidden'); 
                apiKeySection.classList.remove('hidden'); 

                const savedUserApiKey = localStorage.getItem(`elevenLabsApiKey_${currentUser.uid}`);
                apiKeyInput.value = savedUserApiKey || '';
                
                if (apiKeyInput.value.trim()) {
                    fetchVoices(apiKeyInput.value.trim());
                } else {
                    voiceSelect.innerHTML = '<option value="" style="color: #94a3b8;">Please enter your API Key to load voices.</option>';
                    voiceSelect.disabled = true;
                    voiceSearchInput.disabled = true;
                }

            } else {
                currentUser = null;
                console.log("User is signed out.");
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                adminPanelToggleBtn.classList.add('hidden'); 
                apiKeySection.classList.add('hidden'); 
                apiKeyInput.value = ''; 
                allVoices = []; 
                populateVoiceSelect([]); 
                voiceSelect.innerHTML = '<option value="" style="color: #94a3b8;">Enter API Key to load voices...</option>';
                voiceSearchInput.disabled = true;
                voiceSelect.disabled = true;

                adminPanel.classList.remove('open'); 
                isAdminLoggedIn = false;
                if (unsubscribeLogs) unsubscribeLogs();
                if (unsubscribeUsers) unsubscribeUsers();
            }
            updateConvertButtonState(); 
        });
        
        // Login Form
        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            loginError.classList.add('hidden');
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI update
                loginForm.reset();
            } catch (error) {
                console.error("Login error:", error);
                displayLoginError(error.message);
            }
        });

        // Logout Button 
        logoutButton.addEventListener('click', async () => { 
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                displayAppError(error.message);
            }
        });
        
        // Admin Panel Logic
        adminPanelToggleBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) { adminPanel.classList.toggle('open'); } 
            else { adminPasswordModal.classList.add('visible'); adminPasswordInput.focus(); }
        });
        adminModalCloseBtn.addEventListener('click', () => {
            adminPasswordModal.classList.remove('visible'); adminPasswordInput.value = '';
            adminPasswordError.classList.add('hidden');
        });
        adminLoginBtn.addEventListener('click', () => {
            // IMPORTANT: This is a client-side password check and is NOT secure for production.
            // A proper admin system should use Firebase Custom Claims or a dedicated admin role.
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                isAdminLoggedIn = true; adminPasswordModal.classList.remove('visible');
                adminPanel.classList.add('open'); adminPasswordInput.value = '';
                adminPasswordError.classList.add('hidden'); 
                fetchAdminLogs();
                displayUsersInAdminPanel(); // Fetch and display users
            } else {
                adminPasswordError.textContent = "Incorrect password.";
                adminPasswordError.classList.remove('hidden');
            }
        });

        // Admin: Create New User
        adminCreateUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminCreateUserError.classList.add('hidden');
            adminCreateUserSuccess.classList.add('hidden');
            adminCreateUserBtn.disabled = true;

            const name = adminNewUserNameInput.value.trim();
            const email = adminNewUserEmailInput.value.trim();
            const password = adminNewUserPasswordInput.value;
            const expiryDays = parseInt(adminUserExpirySelect.value);

            if (!name || !email || !password) {
                adminCreateUserError.textContent = "All fields are required.";
                adminCreateUserError.classList.remove('hidden');
                adminCreateUserBtn.disabled = false;
                return;
            }

            try {
                // Note: Creating users directly like this from client-side admin panel is generally okay for admin actions,
                // but ensure your Firestore rules for the 'users' collection are secure.
                // This does NOT sign in the admin as the new user.
                
                // Temporary sign-out admin if a robust solution for creating user isn't available without re-auth
                // This is a workaround. Ideally, use Firebase Admin SDK in a Cloud Function.
                // For now, we'll try to create user. If it fails due to auth state, it's a limitation.
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                console.log("Admin created new user in Auth:", newUser.uid);

                await updateProfile(newUser, { displayName: name });

                let expiryDate = null;
                if (expiryDays > 0) {
                    expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + expiryDays);
                }

                const userDocRef = doc(db, "users", newUser.uid);
                await setDoc(userDocRef, {
                    uid: newUser.uid,
                    displayName: name,
                    email: email,
                    createdAt: serverTimestamp(),
                    accountExpiry: expiryDate ? Timestamp.fromDate(expiryDate) : null,
                    createdBy: currentUser ? currentUser.uid : 'admin_direct_creation' // Log who created
                });

                adminCreateUserSuccess.textContent = `User ${name} (${email}) created successfully!`;
                adminCreateUserSuccess.classList.remove('hidden');
                adminCreateUserForm.reset();

                // Important: Re-authenticate the admin if creating users signs them out.
                // This part is tricky with client-side only. The simplest is that admin might need to log back in
                // if the createUserWithEmailAndPassword changes the auth state.
                // onAuthStateChanged should ideally handle the admin's own session.

            } catch (error) {
                console.error("Admin create user error:", error);
                adminCreateUserError.textContent = error.message;
                adminCreateUserError.classList.remove('hidden');
            } finally {
                adminCreateUserBtn.disabled = false;
            }
        });
        
        // Admin: Display Users
        async function displayUsersInAdminPanel() {
            if (!db || !isAdminLoggedIn) return;
            adminManageUsersContainer.innerHTML = '<p>Loading users...</p>';

            const usersCollectionRef = collection(db, "users");
            // Add query(usersCollectionRef, orderBy("createdAt", "desc")) if needed
            
            if(unsubscribeUsers) unsubscribeUsers();

            unsubscribeUsers = onSnapshot(query(usersCollectionRef), (querySnapshot) => {
                if (querySnapshot.empty) {
                    adminManageUsersContainer.innerHTML = '<p>No users found in database.</p>';
                    return;
                }
                adminManageUsersContainer.innerHTML = '';
                querySnapshot.forEach((docSnap) => {
                    const userData = docSnap.data();
                    const userEntry = document.createElement('div');
                    userEntry.classList.add('admin-user-entry');
                    const expiryText = userData.accountExpiry ? userData.accountExpiry.toDate().toLocaleDateString() : 'No Expiry';
                    const isExpired = userData.accountExpiry && userData.accountExpiry.toDate() < new Date();

                    userEntry.innerHTML = `
                        <p><strong>Name:</strong> ${userData.displayName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                        <p><strong>UID:</strong> ${userData.uid || 'N/A'}</p>
                        <p><strong>Expiry:</strong> <span class="${isExpired ? 'text-red-400' : ''}">${expiryText}</span></p>
                        <div class="actions mt-2">
                            <button class="extend-expiry-btn" data-uid="${userData.uid}">Extend 7 Days</button>
                            <button class="delete-user-btn delete-btn" data-uid="${userData.uid}" data-email="${userData.email}">Delete User</button>
                        </div>
                    `;
                    adminManageUsersContainer.appendChild(userEntry);
                });

                // Add event listeners for new buttons
                document.querySelectorAll('.extend-expiry-btn').forEach(button => {
                    button.addEventListener('click', handleExtendExpiry);
                });
                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteUserFirestoreRecord);
                });

            }, (error) => {
                console.error("Error fetching users for admin: ", error);
                adminManageUsersContainer.innerHTML = '<p class="text-red-400">Error loading users.</p>';
            });
        }

        async function handleExtendExpiry(event) {
            const uid = event.target.dataset.uid;
            if (!uid || !confirm(`Extend access for user ${uid} by 7 days?`)) return;

            try {
                const userDocRef = doc(db, "users", uid);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) {
                    alert("User document not found."); return;
                }
                let currentExpiry = userDocSnap.data().accountExpiry ? userDocSnap.data().accountExpiry.toDate() : new Date();
                if (currentExpiry < new Date()) currentExpiry = new Date(); // If expired, extend from now

                const newExpiryDate = new Date(currentExpiry);
                newExpiryDate.setDate(newExpiryDate.getDate() + 7);
                
                await updateDoc(userDocRef, { accountExpiry: Timestamp.fromDate(newExpiryDate) });
                alert(`Access extended for user ${uid}.`);
                // The onSnapshot listener for users should auto-refresh the list.
            } catch (error) {
                console.error("Error extending expiry:", error);
                alert(`Failed to extend expiry: ${error.message}`);
            }
        }
        
        async function handleDeleteUserFirestoreRecord(event) {
            const uid = event.target.dataset.uid;
            const email = event.target.dataset.email;
            if (!uid || !confirm(`Are you sure you want to delete user ${email} (UID: ${uid}) from the database? This will NOT delete their authentication record.`)) return;

            try {
                const userDocRef = doc(db, "users", uid);
                await deleteDoc(userDocRef);
                alert(`User record ${email} deleted from Firestore. You may need to delete their Auth record manually or via Admin SDK.`);
                // The onSnapshot listener for users should auto-refresh the list.
                // IMPORTANT: Deleting the user from Firebase Authentication requires Admin SDK (e.g., in a Cloud Function).
                // Client-side SDK cannot delete other users' Auth records.
                console.warn(`Firestore record for user ${uid} deleted. Auth record for ${email} still exists.`);

            } catch (error) {
                console.error("Error deleting user Firestore record:", error);
                alert(`Failed to delete user record: ${error.message}`);
            }
        }


        async function fetchAdminLogs() { /* ... (same as before, ensure 'db' and 'appId' are used correctly) ... */ }


        // --- Core App Logic (TTS, Voice Fetching etc.) ---
        function updateConvertButtonState() { /* ... (same) ... */ }
        textToConvertInput.addEventListener('input', updateConvertButtonState);
        apiKeyInput.addEventListener('input', () => { /* ... (same) ... */ });
        voiceSearchInput.addEventListener('input', () => { /* ... (same) ... */ });
        async function fetchVoices(apiKeyToUse) { /* ... (same) ... */ }
        function populateVoiceSelect(voicesToDisplay) { /* ... (same) ... */ }
        async function logVoiceGeneration(userName, userEmail, voiceId, modelId, text) { /* ... (same) ... */ }
        convertBtn.addEventListener('click', async () => { /* ... (same, ensure userNameForLog and userEmailForLog are from currentUser) ... */ });
        downloadBtn.addEventListener('click', () => { /* ... (same) ... */ });
        
        function displayLoginError(message) { // Specific for login form
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }
        function displayAppError(message) {
            appErrorMessage.textContent = message; 
            appErrorMessage.classList.remove('hidden'); 
            appErrorMessage.classList.add('visible'); 
        }
        
        window.addEventListener('load', () => {
            if (!app || !auth || !db) {
                console.warn("Firebase is not available. Core functionality will be limited.");
                authContainer.innerHTML = '<p class="text-center text-red-400 p-4">Essential services are unavailable. Please try refreshing the page or contact support.</p>';
                authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); adminPanelToggleBtn.style.display = 'none';
            }
        });
    </script>
</body>
</html>
